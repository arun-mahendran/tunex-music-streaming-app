<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/png" href="{{ url_for('static', filename='tunex.png') }}">
<title>TuneX | Creator Studio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root {
  --bg: radial-gradient(circle at top left, #1b2735, #090a0f);
  --glass: rgba(255,255,255,0.08);
  --border: rgba(255,255,255,0.12);
  --text: #ffffff;
  --muted: rgba(255,255,255,0.65);
  --accent: #4fd1ff;
  --danger: #ff6b6b;
  --success: #10b981;
  --radius-lg: 22px;
  --radius-md: 14px;
  --blur: blur(16px);
  --transition: all 0.3s ease;
}
body.light {
  --bg: linear-gradient(135deg, #f5f7fa, #e4ecf3);
  --glass: rgba(255,255,255,0.9);
  --border: rgba(0,0,0,0.08);
  --text: #111;
  --muted: rgba(0,0,0,0.6);
  --success: #059669;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  min-height: 100vh;
  font-family: "Inter", system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
}
/* OVERLAY FOR BLUR */
#overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.25);
  backdrop-filter: blur(6px);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  z-index: 90;
}
#overlay.active {
  opacity: 1;
  pointer-events: auto;
}
/* HEADER */
header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  padding: 18px 36px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  backdrop-filter: var(--blur);
  background: rgba(0,0,0,0.35);
  border-bottom: 1px solid var(--border);
  z-index: 100;
}
.logo { font-size: 22px; font-weight: 700; }
/* AVATAR + NOTIFICATION WRAPPER */
.avatar-wrapper {
  position: relative;
  z-index: 110;
  display: flex;
  align-items: center;
  gap: 16px;
}
/* DASHBOARD & ANALYTICS BUTTONS - SAME STYLE AS IN ANALYTICS PAGE */
.nav-btn {
  padding: 10px 18px;
  background: rgba(255,255,255,0.12);
  border-radius: 14px;
  font-size: 15px;
  font-weight: 600;
  color: var(--text);
  text-decoration: none;
  transition: var(--transition);
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.nav-btn:hover {
  background: var(--accent);
  color: #000;
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(79,209,255,0.5);
}
/* ACTIVE PAGE BUTTON (DASHBOARD) */
.dashboard-active {
  background: var(--accent);
  color: #000;
  box-shadow: 0 6px 16px rgba(79,209,255,0.4);
  cursor: default;
  pointer-events: none;
}
/* NOTIFICATION BELL */
.notif-bell {
  position: relative;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
  display: grid;
  place-items: center;
  cursor: pointer;
  font-size: 20px;
  transition: var(--transition);
}
.notif-bell:hover {
  background: rgba(79,209,255,0.2);
  transform: scale(1.05);
}
.notif-badge {
  position: absolute;
  top: 6px;
  right: 6px;
  background: var(--danger);
  color: white;
  font-size: 11px;
  font-weight: bold;
  min-width: 18px;
  height: 18px;
  border-radius: 50%;
  display: grid;
  place-items: center;
  padding: 0 4px;
}
/* NOTIFICATION DROPDOWN */
.notif-menu {
  position: absolute;
  right: 60px;
  top: 56px;
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  width: 320px;
  max-height: 400px;
  overflow-y: auto;
  opacity: 0;
  pointer-events: none;
  transform: translateY(-10px);
  transition: var(--transition);
  z-index: 120;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
.notif-menu.active {
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0);
}
.notif-header {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  font-weight: bold;
  font-size: 15px;
}
.notif-item {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
}
.notif-item:last-child {
  border-bottom: none;
}
.notif-time {
  font-size: 12px;
  color: var(--muted);
  margin-top: 6px;
}
/* AVATAR & MENU */
.avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), #89f7fe);
  color: #000;
  display: grid;
  place-items: center;
  font-weight: bold;
  cursor: pointer;
}
.menu {
  position: absolute;
  right: 0;
  top: 56px;
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  min-width: 180px;
  opacity: 0;
  pointer-events: none;
  transform: translateY(-10px);
  transition: var(--transition);
  z-index: 120;
}
.menu.active {
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0);
}
.menu button, .menu a {
  width: 100%;
  padding: 16px 20px;
  background: none;
  border: none;
  text-align: left;
  color: var(--text);
  cursor: pointer;
  text-decoration: none;
  font-size: 15px;
  display: block;
}
.menu a:hover, .menu button:hover {
  background: rgba(255,255,255,0.12);
}
.container {
  max-width: 1200px;
  margin: 140px auto 80px;
  padding: 0 24px 80px;
}
.grid {
  display: grid;
  grid-template-columns: 420px 1fr;
  gap: 30px;
  align-items: start;
}
@media (max-width: 900px) {
  .grid { grid-template-columns: 1fr; }
}
/* UPLOAD CARD */
.card-upload {
  background: var(--glass);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
  padding: 28px;
  backdrop-filter: var(--blur);
  height: fit-content;
}
/* MANAGE SONGS CARD */
.card-manage {
  background: var(--glass);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
  padding: 28px;
  backdrop-filter: var(--blur);
  display: flex;
  flex-direction: column;
  height: 80vh;
  max-height: 800px;
}
.card-manage h3 {
  margin-bottom: 24px;
}
.manage-content {
  flex: 1;
  overflow-y: auto;
  margin-top: 16px;
  padding-right: 8px;
}
.manage-content::-webkit-scrollbar {
  width: 6px;
}
.manage-content::-webkit-scrollbar-track {
  background: transparent;
}
.manage-content::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.2);
  border-radius: 3px;
}
#songSearch {
  width: 100%;
  padding: 14px;
  border-radius: var(--radius-md);
  background: rgba(255,255,255,0.18);
  border: 1px solid var(--border);
  color: var(--text);
  font-size: 15px;
}
#songSearch::placeholder {
  color: var(--muted);
}
.song-row {
  display: grid;
  grid-template-columns: 1fr 280px auto;
  gap: 20px;
  align-items: center;
  padding: 16px 0;
  border-bottom: 1px solid var(--border);
}
.song-info {
  display: flex;
  flex-direction: column;
}
.song-title-input {
  font-size: 16px;
  font-weight: 500;
  background: transparent;
  border: none;
  color: var(--text);
  width: 100%;
}
.song-player audio {
  width: 100%;
  height: 36px;
}
.song-actions {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-self: end;
}
.song-actions button {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 18px;
  color: var(--text);
}
.delete-btn { color: var(--danger); }
.save-btn { color: var(--accent); }
.genre { display: none; }
label { font-size: 13px; color: var(--muted); }
input, select {
  width: 100%;
  padding: 14px;
  margin-top: 6px;
  margin-bottom: 18px;
  border-radius: var(--radius-md);
  background: rgba(255,255,255,0.18);
  color: var(--text);
  border: none;
}
input::placeholder {
  color: var(--muted);
  opacity: 1;
}
select {
  -webkit-appearance: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23ffffff' d='M1 1l5 5 5-5'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
}
body:not(.light) select {
  background-color: rgba(255,255,255,0.12);
}
body:not(.light) select option {
  background-color: #0f172a;
  color: #ffffff;
}
body.light select option {
  background-color: #ffffff;
  color: #000000;
}
button.primary {
  width: 100%;
  padding: 14px;
  border-radius: var(--radius-md);
  border: none;
  background: linear-gradient(135deg, var(--accent), #89f7fe);
  font-weight: 600;
  cursor: pointer;
}
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 130;
}
.modal.active { display: flex; }
.modal-box {
  background: var(--glass);
  border: 1px solid var(--border);
  backdrop-filter: var(--blur);
  border-radius: var(--radius-lg);
  padding: 26px;
  width: 320px;
  text-align: center;
}
.modal-box p {
  margin: 14px 0 22px;
  color: var(--muted);
}
.modal-actions {
  display: flex;
  gap: 12px;
}
.modal-actions button {
  flex: 1;
  padding: 12px;
  border-radius: var(--radius-md);
  border: none;
  cursor: pointer;
}
.cancel-btn {
  background: rgba(255,255,255,0.15);
  color: var(--text);
}
.confirm-btn {
  background: var(--danger);
  color: #fff;
}
/* PERFECT WELCOME MESSAGE */
.welcome-heading {
  font-size: 32px;
  font-weight: 700;
  color: var(--text);
  margin: 0 0 12px 0;
  line-height: 1.2;
}
.welcome-sub {
  color: var(--muted);
  font-size: 17px;
  margin-bottom: 40px;
}
</style>
</head>
<body>
<div id="overlay" onclick="closeMenus()"></div>

<!-- BLOCKED UPLOAD MODAL -->
<div class="modal" id="blockedUploadModal">
  <div class="modal-box">
    <h3>üîí Upload Blocked</h3>
    <p>You cannot upload songs.<br>Your account has been blocked by the admin.</p>
    <div class="modal-actions">
      <button class="confirm-btn" onclick="document.getElementById('blockedUploadModal').classList.remove('active')">OK</button>
    </div>
  </div>
</div>

{% if blocked_upload %}
<script>
  document.getElementById("blockedUploadModal").classList.add("active");
</script>
{% endif %}

<header>
  <div class="logo">TuneX</div>
  <div class="avatar-wrapper">
    <!-- DASHBOARD BUTTON (ACTIVE PAGE) -->
    <div class="nav-btn dashboard-active">Dashboard</div>

    <!-- ANALYTICS BUTTON -->
    <a href="/dashboard/analytics" class="nav-btn">Analytics</a>

    <!-- NOTIFICATION BELL -->
    <div class="notif-bell" onclick="toggleNotifMenu()">
      üîî
      <div class="notif-badge" id="notifBadge">
        {{ notifications|length }}
      </div>
    </div>

    <!-- AVATAR -->
    <div class="avatar" onclick="toggleMenu()">
      {{ username[0]|upper }}
    </div>

    <!-- NOTIFICATION DROPDOWN -->
<div class="notif-menu" id="notifMenu">
  <div class="notif-header">Notifications</div>
  {% if notifications %}
    {% for notif in notifications %}
    <div class="notif-item">
      {{ notif.message }}
      <div class="notif-time" data-timestamp="{{ notif.timestamp.isoformat() }}"></div>
    </div>
    {% endfor %}
  {% else %}
    <div class="notif-item" style="color: var(--muted);">No notifications yet.</div>
  {% endif %}
</div>

    <!-- USER MENU -->
    <div class="menu" id="menu">
      <button onclick="toggleTheme()">Toggle Theme</button>
      <a href="/profile">Profile</a>
      <a href="/logout">Logout</a>
    </div>
  </div>
</header>

<div class="container">
  <!-- WELCOME -->
  <h1 class="welcome-heading">Welcome, {{ username }} üëã</h1>
  <p class="welcome-sub">
    Upload, manage and control your music
  </p>

  <div class="grid">
    <div class="card-upload">
      <h3>Upload Track</h3><br>
      <form action="/creator/upload" method="POST" enctype="multipart/form-data">
        <label>Song Title</label>
        <input type="text" name="title" placeholder="Title" required>
        <label>Genre</label>
        <select name="genre_id" required>
          {% for genre in genres %}
          <option value="{{ genre.genre_id }}">{{ genre.genre_name }}</option>
          {% endfor %}
        </select>
        <label>Audio File</label>
        <input type="file" name="song" required>
        <button class="primary">Upload Song</button>
      </form>
    </div>
    <div class="card-manage">
      <h3>Manage Songs</h3>
      <input type="text" id="songSearch" placeholder="Search songs by title or genre...">
      <div class="manage-content">
        {% for song in songs %}
        <div class="song-row"
             data-title="{{ song.title | lower }}"
             data-genre="{{ song.genre.genre_name | lower }}">
          <div class="song-info">
            <form action="/creator/edit/{{ song.song_id }}" method="POST" style="width:100%;">
              <input class="song-title-input" name="title" value="{{ song.title }}" readonly>
            </form>
            <span class="genre">{{ song.genre.genre_name }}</span>
          </div>
          <div class="song-player">
            <audio controls data-song-id="{{ song.song_id }}">
              <source src="/{{ song.file_path }}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>
          </div>
          <div class="song-actions">
            <button type="button" onclick="enableEdit(this)">‚úèÔ∏è</button>
            <button type="submit" class="save-btn" style="display:none"
              onclick="this.closest('.song-row').querySelector('form').submit()">‚úî</button>
            <button class="delete-btn" onclick="openDeleteModal(this)">üóë</button>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- DELETE SONG MODAL -->
<div class="modal" id="deleteModal">
  <div class="modal-box">
    <h3>Delete Song?</h3>
    <p>This action cannot be undone.</p>
    <div class="modal-actions">
      <button class="cancel-btn" onclick="closeDeleteModal()">Cancel</button>
      <button class="confirm-btn" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<form id="deleteForm" method="POST" style="display:none;"></form>

<script>
let deleteAction = "";

// Relative time for notifications
function formatRelativeTime(dateStr) {
  const date = new Date(dateStr + 'Z');
  const now = new Date();
  const diffMs = now - date;
  const diffSeconds = Math.floor(diffMs / 1000);
  const diffMinutes = Math.floor(diffSeconds / 60);
  const diffHours = Math.floor(diffMinutes / 60);
  const diffDays = Math.floor(diffHours / 24);

  if (diffSeconds < 60) return "just now";
  if (diffMinutes < 60) return diffMinutes + " minute" + (diffMinutes === 1 ? "" : "s") + " ago";
  if (diffHours < 24) return diffHours + " hour" + (diffHours === 1 ? "" : "s") + " ago";
  if (diffDays < 30) return diffDays + " day" + (diffDays === 1 ? "" : "s") + " ago";

  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + 
         " at " + 
         date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
}

document.querySelectorAll('.notif-time[data-timestamp]').forEach(el => {
  el.textContent = formatRelativeTime(el.dataset.timestamp);
});

const notifBadge = document.getElementById("notifBadge");
const currentCount = {{ notifications|length }};

function toggleNotifMenu() {
  const notifMenu = document.getElementById("notifMenu");
  notifMenu.classList.toggle("active");
  document.getElementById("menu").classList.remove("active");
  document.getElementById("overlay").classList.toggle("active");

  if (notifMenu.classList.contains("active")) {
    localStorage.setItem("lastSeenNotificationCount", currentCount);
    if (notifBadge) notifBadge.style.display = "none";
  }
}

const lastSeenCount = parseInt(localStorage.getItem("lastSeenNotificationCount") || "0");
if (lastSeenCount >= currentCount && notifBadge) {
  notifBadge.style.display = "none";
}

function toggleMenu() {
  document.getElementById("menu").classList.toggle("active");
  document.getElementById("notifMenu").classList.remove("active");
  document.getElementById("overlay").classList.toggle("active");
}

function closeMenus() {
  document.getElementById("menu").classList.remove("active");
  document.getElementById("notifMenu").classList.remove("active");
  document.getElementById("overlay").classList.remove("active");
}

function toggleTheme() {
  const isLight = document.body.classList.toggle("light");
  localStorage.setItem("theme", isLight ? "light" : "dark");
}

(function () {
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme === "light") {
    document.body.classList.add("light");
  }
})();

function enableEdit(btn) {
  const row = btn.closest(".song-row");
  const input = row.querySelector(".song-title-input");
  const saveBtn = row.querySelector(".save-btn");
 
  input.removeAttribute("readonly");
  input.focus();
  const length = input.value.length;
  input.setSelectionRange(length, length);
  saveBtn.style.display = "inline";
}

function openDeleteModal(btn) {
  const songRow = btn.closest(".song-row");
  const formAction = songRow.querySelector("form").action;
  deleteAction = formAction.replace("/edit/", "/delete/");
  document.getElementById("deleteModal").classList.add("active");
}

function closeDeleteModal() {
  document.getElementById("deleteModal").classList.remove("active");
}

function confirmDelete() {
  const form = document.getElementById("deleteForm");
  form.action = deleteAction;
  form.submit();
}

/* SEARCH */
document.getElementById("songSearch").addEventListener("input", () => {
  const query = document.getElementById("songSearch").value.trim().toLowerCase();
  const rows = document.querySelectorAll(".song-row");
  rows.forEach(row => {
    const title = row.dataset.title;
    const genre = row.dataset.genre || "";
    if (query === "" || title.includes(query) || genre.includes(query)) {
      row.style.display = "grid";
    } else {
      row.style.display = "none";
    }
  });
});

/* PLAY TRACKING - 30% listened = 1 play */
const audios = document.querySelectorAll("audio");
audios.forEach(audio => {
  let hasCountedPlay = false;
  const checkProgress = () => {
    if (hasCountedPlay) return;
    const duration = audio.duration;
    if (isNaN(duration) || duration === 0) return;
    if (audio.currentTime >= duration * 0.3) {
      hasCountedPlay = true;
      const songId = audio.dataset.songId;
      if (songId) {
        fetch(`/api/song/${songId}/play`, { method: 'POST' })
          .catch(err => console.log("Play count update failed:", err));
      }
    }
  };
  audio.addEventListener("timeupdate", checkProgress);
  audio.addEventListener("play", () => {
    hasCountedPlay = false;
    audios.forEach(other => {
      if (other !== audio) {
        other.pause();
        other.currentTime = 0;
      }
    });
  });
});
</script>
</body>
</html>