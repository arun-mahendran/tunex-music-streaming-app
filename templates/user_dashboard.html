<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/png" href="{{ url_for('static', filename='tunex.png') }}">
<title>TuneX | Listen</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
  --bg: radial-gradient(circle at top, #1b2735, #090a0f);
  --glass: rgba(255,255,255,0.08);
  --border: rgba(255,255,255,0.12);
  --text: #ffffff;
  --muted: rgba(255,255,255,0.65);
  --accent: #4fd1ff;
  --danger: #ff6b6b;
  --radius: 18px;
  --blur: blur(14px);
  --transition: all 0.25s ease;
}

body.light {
  --bg: linear-gradient(135deg, #f5f7fa, #e4ecf3);
  --glass: rgba(255,255,255,0.95);
  --border: rgba(0,0,0,0.08);
  --text: #111;
  --muted: rgba(0,0,0,0.6);
  --danger: #ef4444;
}

body {
  margin: 0;
  font-family: "Inter", system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
}

/* BLOCKED USER OVERLAY */
#blockedOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(12px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 200;
  flex-direction: column;
  text-align: center;
  padding: 20px;
}

#blockedOverlay.active {
  display: flex;
}

#blockedOverlay h2 {
  font-size: 32px;
  margin-bottom: 16px;
  color: white;
}

#blockedOverlay p {
  font-size: 18px;
  color: var(--muted);
  max-width: 600px;
}

/* Disable interactions on songs when blocked */
.blocked #songs-list {
  pointer-events: none;
  opacity: 0.6;
}

/* OVERLAY */
#overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.25);
  backdrop-filter: blur(3px);
  opacity: 0;
  pointer-events: none;
  transition: var(--transition);
  z-index: 15;
}
#overlay.active {
  opacity: 1;
  pointer-events: auto;
}

/* HEADER */
header {
  position: sticky;
  top: 0;
  z-index: 20;
  padding: 18px 36px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  backdrop-filter: var(--blur);
  background: rgba(0,0,0,0.35);
  border-bottom: 1px solid var(--border);
}

.logo {
  font-size: 22px;
  font-weight: 700;
}

/* AVATAR + NOTIFICATION WRAPPER */
.avatar-wrapper {
  position: relative;
  z-index: 30;
  display: flex;
  align-items: center;
  gap: 16px;
}

/* NOTIFICATION BELL */
.notif-bell {
  position: relative;
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
  display: grid;
  place-items: center;
  cursor: pointer;
  font-size: 20px;
}

.notif-badge {
  position: absolute;
  top: 6px;
  right: 6px;
  background: var(--danger);
  color: white;
  font-size: 11px;
  font-weight: bold;
  min-width: 18px;
  height: 18px;
  border-radius: 50%;
  display: grid;
  place-items: center;
  padding: 0 4px;
}

/* NOTIFICATION DROPDOWN */
.notif-menu {
  position: absolute;
  right: 60px;
  top: 54px;
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: 14px;
  width: 320px;
  max-height: 400px;
  overflow-y: auto;
  opacity: 0;
  pointer-events: none;
  transform: translateY(-10px);
  transition: var(--transition);
  z-index: 120;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.notif-menu.active {
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0);
}

.notif-header {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  font-weight: bold;
  font-size: 15px;
}

.notif-item {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
}

.notif-item:last-child {
  border-bottom: none;
}

.notif-time {
  font-size: 12px;
  color: var(--muted);
  margin-top: 6px;
}

/* AVATAR & MENU */
.avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), #89f7fe);
  color: #000;
  display: grid;
  place-items: center;
  font-weight: bold;
  cursor: pointer;
}

.menu {
  position: absolute;
  right: 0;
  top: 54px;
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: 14px;
  min-width: 180px;
  opacity: 0;
  pointer-events: none;
  transform: translateY(-10px);
  transition: var(--transition);
  z-index: 120;
}

.menu.active {
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0);
}

.menu button,
.menu a {
  width: 100%;
  padding: 12px 16px;
  background: none;
  border: none;
  text-align: left;
  color: var(--text);
  cursor: pointer;
  text-decoration: none;
  display: block;
}

.menu a:hover,
.menu button:hover {
  background: rgba(255,255,255,0.1);
}

/* LAYOUT */
.layout {
  display: grid;
  grid-template-columns: 260px 1fr;
}

/* SIDEBAR */
.sidebar {
  padding: 30px;
  border-right: 1px solid var(--border);
}

.nav-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-radius: 10px;
  margin-bottom: 6px;
  padding-right: 8px;
  position: relative;
}

.nav-item a {
  flex: 1;
  padding: 10px;
  color: inherit;
  text-decoration: none;
}

.nav-item.active {
  background: rgba(79,209,255,0.25);
}

/* PLAYLIST MENU */
.playlist-actions {
  cursor: pointer;
  color: var(--muted);
  padding: 6px;
}

.playlist-menu {
  position: absolute;
  left: 100%;
  top: 0;
  margin-left: 10px;
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: 10px;
  min-width: 180px;
  opacity: 0;
  transform: translateY(6px);
  pointer-events: none;
  transition: opacity 0.2s ease, transform 0.2s ease;
  z-index: 50;
  box-shadow: 0 12px 30px rgba(0,0,0,0.25);
}

body.light .playlist-menu {
  background: #ffffff;
  box-shadow: 0 12px 30px rgba(0,0,0,0.12);
}

.playlist-menu.active {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

.playlist-menu input,
.playlist-menu button {
  width: 100%;
  padding: 10px;
  background: none;
  border: none;
  color: var(--text);
  text-align: left;
  cursor: pointer;
  border-bottom: 1px solid var(--border);
}

.playlist-menu button:hover {
  background: rgba(79,209,255,0.15);
}

/* CREATE PLAYLIST */
.create-playlist {
  margin-top: 14px;
}

.create-playlist form {
  display: flex;
  gap: 8px;
}

.create-playlist input {
  flex: 1;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--glass);
  color: var(--text);
}

.create-playlist button {
  padding: 8px 12px;
  border-radius: 8px;
  border: none;
  background: var(--accent);
  color: #000;
  cursor: pointer;
}

/* SONG AREA */
.container {
  padding: 40px;
  max-height: calc(100vh - 120px);
  overflow-y: auto;
}

/* SEARCH + SORT HEADER */
.search-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  gap: 16px;
}

#search {
  flex: 1;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--glass);
  color: var(--text);
  font-size: 16px;
}

.sort-btn {
  padding: 10px 16px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--glass);
  color: var(--text);
  cursor: pointer;
  white-space: nowrap;
  font-size: 14px;
}

.sort-btn:hover {
  background: rgba(79,209,255,0.15);
}

/* TRACK */
.track {
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 20px;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 16px;
  cursor: grab;
}

.track.dragging {
  opacity: 0.5;
  background: rgba(79,209,255,0.2);
}

.track > div:first-child {
  flex: 1 1 200px;
  min-width: 180px;
}

.track > strong {
  display: block;
  font-size: 1.1em;
}

.track > audio {
  flex: 2 1 300px;
  min-width: 250px;
}

.track > .actions {
  display: flex;
  gap: 12px;
  align-items: center;
}

/* REMOVE BUTTON */
.remove-btn {
  font-size: 24px !important;
  color: var(--danger) !important;
  background: none;
  border: none;
  cursor: pointer;
  padding: 8px;
  border-radius: 8px;
  transition: var(--transition);
  line-height: 1;
}

.remove-btn:hover {
  background: rgba(255, 107, 107, 0.2);
  transform: scale(1.1);
}

/* PLAYING INDICATOR */
.track.playing::before {
  content: "";
  position: absolute;
  left: 0;
  top: 12px;
  bottom: 12px;
  width: 5px;
  border-radius: 6px;
  background: var(--accent);
}

/* ADD TO PLAYLIST */
.add-to-playlist {
  display: flex;
  gap: 8px;
  align-items: center;
}

.add-to-playlist select {
  padding: 8px 10px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,0.15);
  color: var(--text);
  min-width: 140px;
  font-size: 14px;
}

.add-to-playlist select option {
  background: #0f172a;
  color: #ffffff;
}

.add-to-playlist button {
  padding: 8px 14px;
  border-radius: 6px;
  border: none;
  background: var(--accent);
  color: #000;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
}

.add-to-playlist button:hover {
  background: #89f7fe;
}

#no-results {
  text-align: center;
  padding: 20px;
  color: var(--muted);
}

/* HIDDEN GENRE */
.genre {
  display: none;
}
</style>
</head>

<body {% if is_blocked %}class="blocked"{% endif %}>
<div id="overlay" onclick="closeMenus()"></div>

<!-- BLOCKED OVERLAY -->
<div id="blockedOverlay" {% if is_blocked %}class="active"{% endif %}>
  <h2>ðŸ”’ Account Blocked</h2>
  <p>You can't listen to songs until the admin unblocks your account.</p>
</div>

<header>
  <div class="logo">TuneX</div>
  <div class="avatar-wrapper">
    <!-- NOTIFICATION BELL -->
    <div class="notif-bell" onclick="toggleNotifMenu()">
      ðŸ””
      {% set unread_count = notifications | selectattr('read', 'equalto', False) | list | length %}
      {% if unread_count > 0 %}
      <div class="notif-badge">{{ unread_count }}</div>
      {% endif %}
    </div>

    <!-- AVATAR -->
    <div class="avatar" onclick="toggleMenu()">
      {{ username[0]|upper }}
    </div>

    <!-- NOTIFICATION DROPDOWN -->
    <div class="notif-menu" id="notifMenu">
      <div class="notif-header">Notifications</div>
      {% if notifications %}
        {% for notif in notifications %}
        <div class="notif-item">
          {{ notif.message }}
          <div class="notif-time" data-timestamp="{{ notif.timestamp.isoformat() }}"></div>
        </div>
        {% endfor %}
      {% else %}
        <div class="notif-item" style="color: var(--muted);">No notifications yet.</div>
      {% endif %}
    </div>

    <!-- USER MENU -->
    <div class="menu" id="menu">
      <button onclick="toggleTheme()">Toggle Theme</button>
      <a href="/profile">Profile</a>
      <a href="/logout">Logout</a>
    </div>
  </div>
</header>

<div class="layout">
  <div class="sidebar">
    <h3>Welcome, {{ username }} ðŸ‘‹</h3>

    <div class="nav-item {% if not active_playlist %}active{% endif %}">
      <a href="/dashboard/user">ðŸŽµ All Songs</a>
    </div>

    <h3 style="margin-top:20px;">Your Playlists</h3>

    {% for p in playlists %}
    <div class="nav-item {% if active_playlist and active_playlist.playlist_id == p.playlist_id %}active{% endif %}">
      <a href="/playlist/{{ p.playlist_id }}">{{ p.playlist_name }}</a>
      <span class="playlist-actions" onclick="event.stopPropagation(); togglePlaylistMenu({{ p.playlist_id }})">â‹®</span>

      <div class="playlist-menu" id="menu-{{ p.playlist_id }}" onclick="event.stopPropagation()">
        <form action="/playlist/rename/{{ p.playlist_id }}" method="POST">
          <input name="name" placeholder="Rename playlist" required>
          <button type="submit">Rename</button>
        </form>
        <form action="/playlist/delete/{{ p.playlist_id }}" method="POST">
          <button type="submit">Delete</button>
        </form>
      </div>
    </div>
    {% endfor %}

    <div class="create-playlist">
      <form action="/playlist/create" method="POST">
        <input name="name" placeholder="New playlist" required>
        <button type="submit">+</button>
      </form>
    </div>
  </div>

  <div class="container">
    <h1>
      {% if active_playlist %}
        {{ active_playlist.playlist_name }}
      {% else %}
        All Songs
      {% endif %}
    </h1>

    <div class="search-header">
      <input type="text" id="search" placeholder="Search songs by title or genre...">
      {% if active_playlist %}
      <button class="sort-btn" id="sortBtn" onclick="toggleSort()">Sort Aâ†’Z</button>
      {% endif %}
    </div>

    <div id="songs-list">
      {% for song in songs %}
      <div class="track" draggable="true" data-song-id="{{ song.song_id }}">
        <div>
          <strong>{{ song.title }}</strong>
          <div style="font-size: 0.9em; color: var(--muted); margin-top: 4px;">
            {{ song.creator.username }}
          </div>
        </div>
        <span class="genre">{{ song.genre.genre_name }}</span>

        <audio controls {% if is_blocked %}disabled{% endif %}>
          <source src="/{{ song.file_path }}">
        </audio>

        {% if not active_playlist %}
        <div class="add-to-playlist">
          <form action="/playlist/add" method="POST">
            <input type="hidden" name="song_id" value="{{ song.song_id }}">
            <select name="playlist_id" required {% if is_blocked %}disabled{% endif %}>
              {% for p in playlists %}
              <option value="{{ p.playlist_id }}">{{ p.playlist_name }}</option>
              {% endfor %}
            </select>
            <button type="submit" {% if is_blocked %}disabled{% endif %}>Add</button>
          </form>
        </div>
        {% endif %}

        {% if active_playlist %}
        <div class="actions">
          <form action="/playlist/remove" method="POST" style="display:inline;">
            <input type="hidden" name="playlist_id" value="{{ active_playlist.playlist_id }}">
            <input type="hidden" name="song_id" value="{{ song.song_id }}">
            <button type="submit" class="remove-btn" title="Remove from playlist" {% if is_blocked %}disabled{% endif %}>ðŸ—‘</button>
          </form>
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <div id="no-results" style="display: none;">No such songs found</div>
  </div>
</div>

<script>
function formatRelativeTime(dateStr) {
  const date = new Date(dateStr + 'Z');
  const now = new Date();
  const diffMs = now - date;
  const diffSeconds = Math.floor(diffMs / 1000);
  const diffMinutes = Math.floor(diffSeconds / 60);
  const diffHours = Math.floor(diffMinutes / 60);
  const diffDays = Math.floor(diffHours / 24);

  if (diffSeconds < 60) return "just now";
  if (diffMinutes < 60) return diffMinutes + " minute" + (diffMinutes === 1 ? "" : "s") + " ago";
  if (diffHours < 24) return diffHours + " hour" + (diffHours === 1 ? "" : "s") + " ago";
  if (diffDays < 30) return diffDays + " day" + (diffDays === 1 ? "" : "s") + " ago";

  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + 
         " at " + 
         date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
}

document.querySelectorAll('.notif-time[data-timestamp]').forEach(el => {
  el.textContent = formatRelativeTime(el.dataset.timestamp);
});

function toggleNotifMenu() {
  const notifMenu = document.getElementById("notifMenu");
  notifMenu.classList.toggle("active");
  document.getElementById("menu").classList.remove("active");
  document.getElementById("overlay").classList.toggle("active");

  if (notifMenu.classList.contains("active")) {
    localStorage.setItem("lastSeenUserNotificationCount", {{ notifications|length }});
    const badge = document.querySelector(".notif-badge");
    if (badge) badge.style.display = "none";
  }
}

const lastSeen = parseInt(localStorage.getItem("lastSeenUserNotificationCount") || "0");
const currentCount = {{ notifications|length }};
if (lastSeen >= currentCount) {
  const badge = document.querySelector(".notif-badge");
  if (badge) badge.style.display = "none";
}

function toggleMenu() {
  document.getElementById("menu").classList.toggle("active");
  document.getElementById("notifMenu").classList.remove("active");
  document.getElementById("overlay").classList.toggle("active");
}

function closeMenus() {
  document.getElementById("menu").classList.remove("active");
  document.getElementById("notifMenu").classList.remove("active");
  document.getElementById("overlay").classList.remove("active");
}

function toggleTheme() {
  const isLight = document.body.classList.toggle("light");
  localStorage.setItem("theme", isLight ? "light" : "dark");
}

(function () {
  if (localStorage.getItem("theme") === "light") {
    document.body.classList.add("light");
  }
})();

function togglePlaylistMenu(id) {
  document.querySelectorAll(".playlist-menu").forEach(m => m.classList.remove("active"));
  document.getElementById("menu-" + id).classList.toggle("active");
}

document.addEventListener("click", () => {
  document.querySelectorAll(".playlist-menu").forEach(m => m.classList.remove("active"));
});

/* CURRENTLY PLAYING */
{% if not is_blocked %}
const audios = document.querySelectorAll("audio");
audios.forEach(currentAudio => {
  currentAudio.addEventListener("play", () => {
    audios.forEach(otherAudio => {
      if (otherAudio !== currentAudio) {
        otherAudio.pause();
        otherAudio.currentTime = 0;
        otherAudio.closest(".track")?.classList.remove("playing");
      }
    });
    currentAudio.closest(".track").classList.add("playing");
  });
  currentAudio.addEventListener("ended", () => {
    currentAudio.closest(".track").classList.remove("playing");
  });
});
{% endif %}

/* BLOCKED USER: ALERT ON CLICK */
{% if is_blocked %}
document.querySelectorAll('.track, audio').forEach(el => {
  el.addEventListener('click', e => {
    e.preventDefault();
    alert("You cannot listen to songs until the admin unblocks you.");
  });
});
{% endif %}

/* SEARCH */
const searchInput = document.getElementById("search");
const tracks = document.querySelectorAll("#songs-list .track");
searchInput.addEventListener("input", () => {
  const query = searchInput.value.trim().toLowerCase();
  let hasResults = false;
  tracks.forEach(track => {
    const title = track.querySelector("strong").textContent.toLowerCase();
    const genre = track.querySelector(".genre").textContent.trim().toLowerCase();
    if (query === "" || title.includes(query) || genre.includes(query)) {
      track.style.display = "flex";
      hasResults = true;
    } else {
      track.style.display = "none";
    }
  });
  document.getElementById("no-results").style.display = hasResults ? "none" : "block";
});

/* SORT (only in playlist) */
let isSortedAlphabetically = false;

function toggleSort() {
  isSortedAlphabetically = !isSortedAlphabetically;
  const sortBtn = document.getElementById("sortBtn");
  sortBtn.textContent = isSortedAlphabetically ? "Original Order" : "Sort Aâ†’Z";

  const container = document.getElementById("songs-list");
  const trackArray = Array.from(container.querySelectorAll(".track"));

  if (isSortedAlphabetically) {
    trackArray.sort((a, b) => {
      const titleA = a.querySelector("strong").textContent.trim();
      const titleB = b.querySelector("strong").textContent.trim();
      return titleA.localeCompare(titleB);
    });
  } else {
    trackArray.sort((a, b) => {
      return a.dataset.originalIndex - b.dataset.originalIndex;
    });
  }

  trackArray.forEach(track => container.appendChild(track));
}

/* Preserve original order */
document.querySelectorAll("#songs-list .track").forEach((track, index) => {
  track.dataset.originalIndex = index;
});

/* DRAG & DROP REORDERING (only in playlist and if not blocked) */
{% if active_playlist and not is_blocked %}
let draggedTrack = null;

tracks.forEach(track => {
  track.addEventListener("dragstart", e => {
    draggedTrack = track;
    track.classList.add("dragging");
  });

  track.addEventListener("dragend", () => {
    track.classList.remove("dragging");
    draggedTrack = null;
    updatePlaylistOrder();
  });

  track.addEventListener("dragover", e => {
    e.preventDefault();
  });

  track.addEventListener("drop", e => {
    e.preventDefault();
    if (draggedTrack && draggedTrack !== track) {
      const allTracks = Array.from(document.querySelectorAll("#songs-list .track"));
      const fromIndex = allTracks.indexOf(draggedTrack);
      const toIndex = allTracks.indexOf(track);

      if (fromIndex < toIndex) {
        track.parentNode.insertBefore(draggedTrack, track.nextSibling);
      } else {
        track.parentNode.insertBefore(draggedTrack, track);
      }
    }
  });
});

function updatePlaylistOrder() {
  const trackElements = document.querySelectorAll("#songs-list .track");
  const newOrder = Array.from(trackElements).map((t, index) => ({
    song_id: t.dataset.songId,
    position: index + 1
  }));

  fetch('/playlist/reorder/{{ active_playlist.playlist_id }}', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ order: newOrder })
  });
}
{% endif %}
</script>

</body>
</html>